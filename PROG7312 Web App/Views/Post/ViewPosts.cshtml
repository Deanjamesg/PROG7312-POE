@using PROG7312_Web_App.Models;
@model List<Post>;

@{
    ViewData["Title"] = "Local Events and Announcements";
}

<div class="posts">
    <div class="container-fluid mt-4">
        <div class="row">

            <div class="col-lg-3 d-none d-lg-block">
                <div class="sidebar-filters">
                    <h1 class="mb-4"><i class="bi bi-funnel me-2"></i>Filters</h1>

                    <div class="mb-5">
                        <label for="postTypeFilter" class="form-label fs-4 fw-medium">Post Type</label>
                        <select id="postTypeFilter" class="form-select fs-5">
                            <option value="">All Posts</option>
                            <option value="@PostType.LocalEvent">Local Events</option>
                            <option value="@PostType.Announcement">Announcements</option>
                        </select>
                    </div>

                    <div class="mb-5">
                        <label for="eventCategoryFilter" class="form-label fs-4 fw-medium">Event Category</label>
                        <select id="eventCategoryFilter" class="form-select fs-5">
                            <option value="">All Categories</option>
                            @foreach (EventCategory cat in Enum.GetValues(typeof(EventCategory)))
                            {
                                <option value="@cat">@cat.GetDisplayName()</option>
                            }
                        </select>
                    </div>

                    <div class="mb-5">
                        <label class="form-label fs-4 fw-medium">Date Range</label>
                        <div class="input-group mb-4">
                            <span class="input-group-text fs-5">From</span>
                            <input type="date" id="startDate" class="form-control fs-5">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text fs-5">To</span>
                            <input type="date" id="endDate" class="form-control fs-5">
                        </div>
                    </div>

                    <div class="d-grid">
                        <button id="resetFilters" class="btn btn-lg btn-dark">Reset All Filters</button>
                    </div>

                </div>
            </div>

            <div class="col-lg-9">
                <div class="container">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="search" id="searchInput" class="form-control form-control-lg" placeholder="Search events and announcements..." list="pastSearches">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <datalist id="pastSearches">
                                </datalist>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <label class="input-group-text" for="sortOrder">Sort By</label>
                                <select id="sortOrder" class="form-select form-select-lg">
                                    <option value="DatePublishedDesc">Most Recent</option>
                                    <option value="DatePublishedAsc">Oldest First</option>
                                    <option value="TitleAsc">Title (A-Z)</option>
                                    <option value="CategoryAsc">Category</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="postsContainer">
                        @await Html.PartialAsync("_PostList", Model)
                    </div>
                </div>


                <div id="noResultsMessage" class="text-center p-5" style="display: none;">
                    <i class="bi bi-emoji-frown" style="font-size: 3rem;"></i>
                    <h3 class="mt-3">No Posts Found</h3>
                    <p class="lead text-muted">Try adjusting your search or filter criteria.</p>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="postDetailModal" tabindex="-1" aria-labelledby="postDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-white" style="background:#3d3d3d;">
                <h1 class="modal-title fs-4" id="postDetailModalLabel">Post Details</h1>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-lg btn-dark" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {

            let debounceTimeout;
            $('#searchInput').on('keyup', function() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(fetchPosts, 400); // Wait 400ms after user stops typing
            });

            // Event Handlers for Filters and Sorting
            $('#postTypeFilter, #eventCategoryFilter, #startDate, #endDate, #sortOrder').on('change', fetchPosts);

            // Reset Filters Button Handler
            $('#resetFilters').on('click', function() {
                $('#postTypeFilter, #eventCategoryFilter, #sortOrder').prop('selectedIndex', 0);
                $('#startDate, #endDate, #searchInput').val('');
                fetchPosts();
            });

            function fetchPosts() {
                const searchData = {
                    searchTerm: $('#searchInput').val(),
                    postType: $('#postTypeFilter').val(),
                    category: $('#eventCategoryFilter').val(),
                    startDate: $('#startDate').val(),
                    endDate: $('#endDate').val(),
                    sortOrder: $('#sortOrder').val()
                };

                // Make Call Controller and Get Results
                $.ajax({
                    url: '@Url.Action("FilterPosts", "Post")',
                    type: 'GET',
                    data: searchData,
                    success: function(result) {
                        $('#postsContainer').html(result);

                        // Check if Returned Result is Empty and Show/Hide the "No Results"
                        if ($(result).find('.post-card').length > 0) {
                            $('#noResultsMessage').hide();
                            $('#postsContainer').show();
                        } else {
                            $('#noResultsMessage').show();
                            $('#postsContainer').hide();
                        }
                    },
                    error: function() {
                        alert('An error occurred while fetching data.');
                    }
                });
            }
            $('#postsContainer').on('click', '.view-post-details', function () {
                const postId = $(this).data('post-id');
                const modal = new bootstrap.Modal(document.getElementById('postDetailModal'));
                const modalBody = $('#postDetailModal .modal-body');
                const modalTitle = $('#postDetailModalLabel');

                // Loading Spinner while Fetching Data
                modalBody.html('<div class="d-flex justify-content-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                modalTitle.text('Loading Details...');
                modal.show();

                // AJAX Call to Controller to get the Post Details
                $.ajax({
                    url: '@Url.Action("GetPostDetails", "Post")',
                    type: 'GET',
                    data: { id: postId },
                    success: function (result) {
                        modalBody.html(result);
                        modalTitle.text('Post Details');
                    },
                    error: function () {
                    modalBody.html('<p class="text-danger">Sorry, an error occurred while loading the details.</p>');
                }
            });
        });


        const urlParams = new URLSearchParams(window.location.search);
        const postIdFromUrl = urlParams.get('postId');

        if (postIdFromUrl) {
            const cardToClick = $(`.view-post-details[data-post-id='${postIdFromUrl}']`);
            if (cardToClick.length) {
                setTimeout(function() {
                    cardToClick.trigger('click');
                }, 100);
            }
        }
        });
    </script>
}